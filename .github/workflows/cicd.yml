name: CI & CD Pipeline

on:
  push:
    branches: [development, main]
  pull_request:
    branches: [main]

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - uses: actions/checkout@v4  # Add this to enable git commands

      - name: Check if merge commit to development
        id: check
        run: |
          echo "Checking if should skip CI..."

          if [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            parents=$(git log -1 --pretty=%P)
            parent_count=$(echo $parents | wc -w)

            if [ "$parent_count" -gt 1 ]; then
              echo "should_skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "should_skip=false" >> $GITHUB_OUTPUT
  ci-check:
    needs: precheck
    if: needs.precheck.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.4

      - name: Install dependencies
        run: npm install

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test

  deploy-preview:
    needs: [precheck, ci-check]
    if: needs.precheck.outputs.should_skip != 'true' && github.ref == 'refs/heads/development'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel Preview
        run: npx vercel --token=${{ secrets.JOBPILOTTOKEN }} --confirm --name job-pilot

  deploy-production:
    needs: [precheck, ci-check]
    if: needs.precheck.outputs.should_skip != 'true' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel Production
        run: npx vercel --prod --token=${{ secrets.JOBPILOTTOKEN }} --confirm --name job-pilot
